# Node Builder

Node Builder is a widget that automatically generates and executes Allye workflows by interacting with the AI assistant "Allye".

## Input

- **Data**: (Orange.data.Table, Optional)
  - The dataset for analysis. If not connected, Allye may suggest a workflow that includes a file loading widget.

## Output

- **out_data**: (Orange.data.Table)
  - Outputs the input `Data` as is. This widget itself does not process the data.

## Features

The Node Builder widget primarily provides the following features:
![Node builder overview](./imgs/nodebuilder_overview.png)

1.  **Interaction with AI Assistant**:
    *   Allows users to instruct analysis tasks in natural language through a chat interface.
    *   Allye interprets the instructions and responds.
2.  **Workflow Auto-Generation**:
    *   Allye suggests an Allye workflow suitable for the analysis purpose, either through the "Build Nodes" button or via chat instructions.
    *   The suggested workflow is automatically placed and connected as nodes on the canvas.
3.  **Data Integration**:
    *   Supports the generation of more data-appropriate workflows by sending column information (variable name, type, role) and a small amount of sample data from the input dataset to Allye.
    *   The transmission of this information can be controlled by the user in the control panel.
4.  **Variable Management**:
    *   Allows users to classify variables in the dataset into "Features," "Target Variables," and "Meta Variables" in the control panel. This classification information is provided to Allye.
5.  **Python Code Execution and Validation**:
    *   Attempts basic validation and auto-correction of Python code generated by Allye (especially data processing code executed within the Notebook widget).

## UI Description

The Node Builder widget interface mainly consists of a chat area and a control area.

### Main Area (Chat)

1.  **Header**:
    *   **Title (A)**: "Analytics Assistant"
    *   **Status Label (B)**: Displays Allye's status (e.g., Ready, Thinking..., Error occurred).
2.  **Chat Area (C)**:
    *   Displays messages from Allye (welcome message, responses, system logs, etc.) and messages sent by the user.
    *   Code and workflow plans generated by Allye are also displayed here.
3.  **Input Area (D)**:
    *   **Text Input Box**: Enter instructions or questions for Allye here. Can also be submitted with "Cmd+Enter" or "Ctrl+Enter".
    *   **Send Button (Paper Airplane Icon)**: Sends the entered message to Allye.

### Control Area (Side Panel)

1.  **Data Variables (E)**:
    Manages variables from the input dataset. Variables can be dragged and dropped to change their roles.
    *   **Features**: Features used for analysis.
    *   **Target Variables**: Target variables, such as for prediction.
    *   **Meta Variables**: Meta variables not directly used in analysis but kept as reference information.
2.  **Auto Generation (F)**:
    *   **Build Nodes Button**: Instructs Allye to automatically generate an entire workflow based on the input data and current conversation context. If no data is connected, it may suggest starting from data source creation.
3.  **Action Settings (G)**:
    Controls the data information sent to Allye.
    *   **Send column and attribute information**: If checked, sends header information to Allye, such as dataset column names, types, roles (Features/Target/Meta), and the number of unique values for categorical variables.
    *   **Send sample data (5 rows)**: If checked, sends 5 random rows of sample data from the dataset to Allye. **Caution: Raw data will be shared with the LLM.**

## Usage Examples

![nodebuilder_flow](./imgs/nodebuilder_flow.png)

### Example 1: Node Generation via Chat Instructions

1.  Connect a dataset (e.g., `iris.tab`) from a File widget or similar to the Node Builder widget.
2.  In the Node Builder's chat input box, type "Create a scatter plot with petal length and petal width" and send.
3.  Allye interprets the instruction, generates a Scatter Plot widget, connects it to the input data, and sets the specified variables.

### Example 2: Automatic Workflow Generation with "Build Nodes" Button

1.  Connect a dataset (e.g., `housing.tab`) from a File widget or similar to the Node Builder widget.
2.  Click the "Build Nodes" button in the control area.
3.  Allye considers the dataset's content (based on column information, sample data, and variable role settings) and general analysis flows to suggest and generate a workflow that may include data preprocessing, visualization, model building, etc.

### Example 3: Python Code Generation within Notebook Widget

1.  Connect data from a File widget to Node Builder.
2.  In chat, instruct: "Generate Python code in a Notebook to extract data where age is 30 or greater."
3.  Allye generates a Notebook widget and writes Python code like the following inside it:
    ```python
    # Assume df is the input dataframe
    df_filtered = df[df['age'] >= 30]
    ```
    Node Builder interprets the generated code and configures the Notebook widget to output `df`.

## Settings and API Key

![user_settings](./imgs/user_settings.png)

![user_setting_icon](./imgs/user_setting_icon.png)

*   The API key must be correctly set in User Settings. If this file does not exist or the API key is not set, the widget will display a warning in the chat area, and API communication features will not be available.